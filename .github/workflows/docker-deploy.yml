name: CI/CD IAM Role Based Docker Deploy

on:
  push:
    branches: [ "main", "release" ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # ---------------------------------------------------
      # 1. Docker Build & Push (모든 브랜치 공통 실행)
      # ---------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 브랜치에 따라 태그를 다르게 설정
      # main -> dev 태그 / release -> latest 태그
      - name: Docker Meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/caring-back
          tags: |
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/release' }}
            type=raw,value=dev,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/caring-back:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/caring-back:buildcache,mode=max

      # ---------------------------------------------------
      # 2. Deploy Steps (release 브랜치일 때만 실행)
      # ---------------------------------------------------

      # 설정 파일 가져오기 (배포할 때만 필요하므로 조건 추가)
      - name: Checkout Config Repository
        if: github.ref == 'refs/heads/release'
        uses: actions/checkout@v4
        with:
          repository: safori-team/Caring-Back-Env
          token: ${{ secrets.GH_PAT }}
          path: config-repo

      # 설정 파일 압축
      - name: Bundle Config Files
        if: github.ref == 'refs/heads/release'
        id: config
        run: |
          echo "Bundling configuration files..."
          tar -czf configs.tar.gz --exclude=.git -C config-repo .
          CONFIG_DATA=$(base64 -w 0 configs.tar.gz)
          echo "CONFIG_DATA=$CONFIG_DATA" >> $GITHUB_OUTPUT

      # AWS 인증
      - name: Configure AWS credentials
        if: github.ref == 'refs/heads/release'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      # SSM 배포 실행
      - name: Deploy via AWS SSM
        if: github.ref == 'refs/heads/release'
        run: |
          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:DeployGroup,Values=Caring-Server" \
            --max-concurrency "100%" \
            --max-errors "0" \
            --parameters 'commands=[
              "echo [Deploy] Starting Production Deployment...",
              "echo [Deploy] Target Info: $(hostname)",
              "mkdir -p /home/ubuntu/caring-voice/credentials",
              "rm -rf /home/ubuntu/caring-voice/credentials/*",
              "echo ${{ steps.config.outputs.CONFIG_DATA }} | base64 -d > /tmp/configs.tar.gz",
              "tar -xzf /tmp/configs.tar.gz -C /home/ubuntu/caring-voice/credentials",
              "rm /tmp/configs.tar.gz",
              "chmod -R 600 /home/ubuntu/caring-voice/credentials/*",
              "echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin",
              "docker pull ${{ secrets.DOCKER_USERNAME }}/caring-back:latest",
              "docker stop caring-server || true",
              "docker rm caring-server || true",
              "docker run -d --name caring-server --restart always -p 8000:8000 --env-file /home/ubuntu/caring-voice/credentials/docker.env -v /home/ubuntu/caring-voice/credentials:/caring-voice/credentials ${{ secrets.DOCKER_USERNAME }}/caring-back:latest",
              "docker image prune -f",
              "echo [Deploy] SUCCESS on $(hostname)!"
            ]' \
            --comment "Production Deploy from Release Branch"
