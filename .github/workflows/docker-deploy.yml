name: CI/CD IAM Role Based Docker Deploy

on:
  push:
    branches: [ "main", "release", "docker" ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # ---------------------------------------------------
      # 1. Docker Build & Push (모든 브랜치 공통 실행)
      # ---------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker Meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/caring-back
          tags: |
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/release' }}
            type=raw,value=docker,enable=${{ github.ref == 'refs/heads/docker' }}
            type=raw,value=dev,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          # 레이어 캐시를 적극 활용하도록 설정 유지
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/caring-back:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/caring-back:buildcache,mode=max

      # ---------------------------------------------------
      # Deploy Steps (release 혹은 docker 브랜치일 때 실행)
      # ---------------------------------------------------
      - name: Checkout Config Repository
        if: github.ref == 'refs/heads/release' || github.ref == 'refs/heads/docker'
        uses: actions/checkout@v4
        with:
          repository: safori-team/Caring-Back-Env
          token: ${{ secrets.GH_PAT }}
          path: config-repo

      - name: Bundle Config Files
        if: github.ref == 'refs/heads/release' || github.ref == 'refs/heads/docker'
        id: config
        run: |
          echo "Bundling configuration files..."
          tar -czf configs.tar.gz --exclude=.git -C config-repo .
          CONFIG_DATA=$(base64 -w 0 configs.tar.gz)
          echo "CONFIG_DATA=$CONFIG_DATA" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        if: github.ref == 'refs/heads/release' || github.ref == 'refs/heads/docker'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy via AWS SSM
        if: github.ref == 'refs/heads/release' || github.ref == 'refs/heads/docker'
        env:
          TARGET_TAG: ${{ github.ref == 'refs/heads/release' && 'latest' || 'docker' }}
        run: |
          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:DeployGroup,Values=Caring-Server" \
            --max-concurrency "100%" \
            --max-errors "0" \
            --parameters 'commands=[
              "echo [Deploy] Starting Deployment for tag: ${{ env.TARGET_TAG }}...",
          
              "mkdir -p /home/ubuntu/caring-voice/credentials",
              "mkdir -p /home/ubuntu/.cache/huggingface",
              "chmod 777 /home/ubuntu/.cache/huggingface",

              "rm -rf /home/ubuntu/caring-voice/credentials/*",
              "echo ${{ steps.config.outputs.CONFIG_DATA }} | base64 -d > /tmp/configs.tar.gz",
              "tar -xzf /tmp/configs.tar.gz -C /home/ubuntu/caring-voice/credentials",
              "rm /tmp/configs.tar.gz",
              "chmod -R 600 /home/ubuntu/caring-voice/credentials/*",
          
              "echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin",
          
              "echo [Deploy] Pulling image...",
              "docker pull ${{ secrets.DOCKER_USERNAME }}/caring-back:${{ env.TARGET_TAG }}",
          
              "docker stop caring-server || true",
              "docker rm caring-server || true",
          
              "echo [Deploy] Running container...",
              "docker run -d --name caring-server --restart always -p 8000:8000 --env-file /home/ubuntu/caring-voice/credentials/docker.env -v /home/ubuntu/caring-voice/credentials:/caring-voice/credentials -v /home/ubuntu/.cache/huggingface:/data/model_cache ${{ secrets.DOCKER_USERNAME }}/caring-back:${{ env.TARGET_TAG }}",
          
              "docker image prune -f",
              "echo [Deploy] SUCCESS!"
            ]' \
            --comment "Deploying ${{ env.TARGET_TAG }} from ${{ github.ref_name }}"
