name: CI/CD IAM Role Based Docker Deploy

on:
  push:
    branches: [ docker ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Checkout Config Repository
        uses: actions/checkout@v4
        with:
          repository: safori-team/Caring-Back-Env
          token: ${{ secrets.GH_PAT }}
          path: config-repo

      - name: Bundle Config Files
        id: config
        run: |
          echo "Bundling configuration files..."
          # exclude 옵션 순서 수정됨 (tar -C 앞)
          tar -czf configs.tar.gz --exclude=.git -C config-repo .
          
          # Base64 인코딩
          CONFIG_DATA=$(base64 -w 0 configs.tar.gz)
          echo "CONFIG_DATA=$CONFIG_DATA" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/caring-back:latest
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/caring-back:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/caring-back:buildcache,mode=max

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy via AWS SSM
        run: |
          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=instanceids,Values=${{ secrets.EC2_INSTANCE_ID }}" \
            --parameters 'commands=[ \
              "echo [Deploy] Starting deployment process...", \
              "echo [Deploy] 1. Setting up credentials directory...", \
              "mkdir -p /home/ubuntu/caring-voice/credentials", \
              "echo [Deploy] 2. Cleaning old configs...", \
              "rm -rf /home/ubuntu/caring-voice/credentials/*", \
              "echo [Deploy] 3. Deploying New Configs...", \
              "echo ${{ steps.config.outputs.CONFIG_DATA }} | base64 -d > /tmp/configs.tar.gz", \
              "tar -xzf /tmp/configs.tar.gz -C /home/ubuntu/caring-voice/credentials", \
              "rm /tmp/configs.tar.gz", \
              "chmod -R 600 /home/ubuntu/caring-voice/credentials/*", \
              "echo [Deploy] 4. Docker Login & Pull...", \
              "echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin", \
              "docker pull ${{ secrets.DOCKER_USERNAME }}/caring-back:latest", \
              "echo [Deploy] 5. Restarting Container...", \
              "docker stop caring-server || true", \
              "docker rm caring-server || true", \
              "echo [Deploy] 6. Starting new container...", \
              "docker run -d --name caring-server --restart always -p 8000:8000 --env-file /home/ubuntu/caring-voice/credentials/docker.env -v /home/ubuntu/caring-voice/credentials:/caring-voice/credentials ${{ secrets.DOCKER_USERNAME }}/caring-back:latest", \
              "echo [Deploy] 7. Cleanup...", \
              "docker image prune -f", \
              "echo [Deploy] SUCCESS!" \
            ]' \
            --comment "Deploying caring-back with Config Repo and docker.env"
